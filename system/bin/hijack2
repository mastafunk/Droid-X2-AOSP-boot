#!/system/bin/sh
PATH=/sbin:/system/bin:/system/xbin
/system/bin/mot_boot_mode.bin "$@"

USBMODE=$(getprop ro.usb_mode)
AFFINITY=$(taskset -p 1 | awk {'print $6'})

if [ ! -d /data/2nd-init ]; then
  mkdir /data/2nd-init
fi

echo "$USBMODE" >> /data/2nd-init/mode

if [ "$USBMODE" = "debug" ]; then
echo "usbmodetest ok" >> /data/2nd-init/log
echo "" >> /data/2nd-init/log
echo `date` >> /data/2nd-init/log

  if [ "$AFFINITY" -eq 3 ]; then

    echo "Attempting 2nd-init" >> /data/2nd-init/log

    mount -o remount,rw rootfs / >> /data/2nd-init/log 2>&1
    cp -p /system/xbin/busybox /sbin
    cp -p /system/xbin/2nd-init /sbin
    cp -p /system/xbin/taskset /sbin
    cp -p /system/xbin/log_init.sh /
    cp -p /system/xbin/hijack.killall /sbin
    #cat /system/etc/rootfs/init.rc /init.rc
    rm /init.rc
    ln -s /system/etc/aosp_fs/init.rc /init.rc
    sync;sync
    #/sbin/hijack.killall >> /data/2nd-init/log 2>&1
    sleep 3
    /sbin/taskset -p -c 0 1 >> /data/2nd-init/log 2>&1
    sync;sync
    /sbin/taskset -c 0 /sbin/2nd-init >> /data/2nd-init/log 2>&1

  else

    echo "Hey!! Weve Made it around This being is being called from the new init.rc" >> /data/2nd-init/log 2>&1
    taskset -p -c 0,1 1 >> /data/2nd-init/log 2>&1

  fi

fi

